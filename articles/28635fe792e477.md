---
title: ""
emoji: "🌏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [reactnative, expo]
published: false
---

## はじめに
React Native & Expoで開発しているアプリにGoogle Mapsを表示したく、[`react-native-maps`](https://docs.expo.dev/versions/latest/sdk/map-view/)というライブラリを使用しました。

![Google Mapsのイメージ](/images/28635fe792e477/map.png =250x)

Google Mapsを使用する場合にはAPI keyが必要となりますが、webとは異なったビルドプロセスと環境変数の管理に悩まされたので、ここにまとめておきます。

## やりたかったこと
- Google Mapsを使いたい（ただこれだけ）
- 上記を実現するためにはAPI keyが必要なので環境変数にて管理したい
- ExpoのEASビルドを行う場合、**クラウドビルド** or **ローカルビルド**の選択肢があるが、どちらの場合でも環境変数による注入ができるようにしたい

:::message
今回取り扱いたいAPI keyは**Secret**として公開したくない情報ですが、逆に公開してもよい内容の場合、ローカルビルドでもExpo project上の設定を参照してくれるため、後述するローカルビルド用の設定は不要となります。
:::

## 前提情報
- expo: 54.0.9
- react-native-maps: 1.20.1

## ビルド

Expoでビルドを行う場合、クラウドビルドが一番簡単ですが、無料枠としては月30回という制約があります。

また、ビルド可能回数とは別に、時間帯？によってはビルド待ちで数十分待つ必要があり、開発サイクルを早めるためにもローカルでもビルドできるように備えておきたいところです。

今回は下記のような`app.config.ts`に対して、環境変数で設定した内容を適用するようにします。

```ts
import type { ConfigContext, ExpoConfig } from "expo/config";

export default ({ config }: ConfigContext): ExpoConfig => ({
  ...config,
  name: config?.name ?? "app name",
  slug: config?.slug ?? "my project",
  ios: {
    ...config.ios,
    config: {
      ...config.ios?.config,
      googleMapsApiKey: process.env.IOS_GOOGLE_MAPS_API_KEY // ここ
    },
  },
  android: {
    ...config.android,
    config: {
      ...config.android?.config,
      googleMaps: {
        apiKey: process.env.ANDROID_GOOGLE_MAPS_API_KEY // ここ
      },
    },
  },  
});
```

### クラウドビルド
クラウドビルドは特に難しいことを考えず、ドキュメント通りに進めてビルドすることができます。

Expoのコンソール上の`Environment variables`から`Secret`としてapi keyを登録します。

**Project → Variables** から環境変数を追加  
   - `ANDROID_GOOGLE_MAPS_API_KEY`
   - `IOS_GOOGLE_MAPS_API_KEY`

![環境変数の設定](/images/28635fe792e477/env.png)

あとは下記のようなコマンドで実行するだけで上記で設定した内容を参照してくれます。
```bash
eas build -p android --profile preview
```

### ローカルビルド
問題のローカルビルドです。

何が問題かというと、EASビルドをローカルで行う場合は基本的に`.env`を読み込んでくれません。（また、読み込まれない状態が望ましいはず）

ローカルのEASビルドはクラウドのEASビルドをミュレートするように実行されますが、その際に`.env`のようなgitignoreされているためファイルは参照することができません。

@[card](https://github.com/expo/eas-cli/issues/2594)

`export`による環境変数の宣言を行い、`eas build`コマンドを実行することで解決することができますが、毎回実行するのは現実的ではないので何とかしたいところです。

スクリプトを用意する方法やdirenvを使う方法も考えましたが、やりたいことに対して無駄な複雑性を持ち込むことはしたくなかったため、結局下記のように`.env`内の定義をシェルに展開する方採りました。

```bash
export $(cat .env | xargs) && eas build -p android --profile preview --local
```

:::message
このあたりのExpoを使用する場合の環境変数管理について、よい方法があれば教えていただけると助かります。
:::

### 補足
ビルドせずに`expo start`によるexpo goでの起動の場合はAPI keyを設定しなくてもmapが表示されます。

API keyが正しく設定されていない状態でビルドされたアプリを起動すると、アプリがクラッシュするような挙動となります。

## 参考
@[card](https://zenn.dev/dev_zacker/articles/768bd4fd0bfcad#appendix)
@[card](https://docs.expo.dev/versions/latest/sdk/map-view/)
